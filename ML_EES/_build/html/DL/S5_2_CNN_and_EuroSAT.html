

<!DOCTYPE html>


<html >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>6.3. Land Use and Land Cover Classification using CNN &#8212; Machine Learning for Earth and Environmental Sciences</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'DL/S5_2_CNN_and_EuroSAT';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="7. Recurrent Neural Networks and Hydrological Modeling" href="Week_6_Recurrent_NN.html" />
    <link rel="prev" title="6.2. Deep Computer Vision" href="S5_1_CNNs.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="None"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../index.html">
                    Welcome to Machine Learning for Earth and Environmental Sciences
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Milton/00_Running_Python_Scripts.html">Running Python scripts</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">(Part I) Basics of Scientific Programming for Applied Machine Learning</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../IP/intro_python.html">1. Introduction to Python for Earth and Environmental Sciences</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../IP/W1_S1_Tutorial.html">1.1. Variables, Control Flow, and File I/O</a></li>
<li class="toctree-l2"><a class="reference internal" href="../IP/W1_S1.html">1.2. (Exercises) Text and Tabular Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../IP/W1_S2_Tutorial.html">1.3. Data Structure, Functions, and Classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../IP/W1_S2.html">1.4. (Exercises) Simple Data Structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../IP/W2_S1_Tutorial.html">1.5. Scientific Computing with Numpy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../IP/W2_S1.html">1.6. (Exercise) Ocean Floats Data Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../IP/W2_S2_Tutorial.html">1.7. Visualization with Matplotlib and Cartopy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../IP/W2_S2.html">1.8. (Exercises) Replicating plots</a></li>
<li class="toctree-l2"><a class="reference internal" href="../IP/W3_S1_Tutorial.html">1.9. Tabular Data with Pandas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../IP/W3_S1.html">1.10. (Exercise) Earthquake Data Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../IP/W3_S2_Tutorial.html">1.11. Geospatial Data with Geopandas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../IP/W3_S2.html">1.12. (Exercise) Hurricane Track Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../IP/W4_S1_Tutorial.html">1.13. Regression, Classification, and Clustering with Scikit-learn</a></li>
<li class="toctree-l2"><a class="reference internal" href="../IP/W4_S1.html">1.14. (Exercises) Multivariate linear regression and clustering</a></li>
<li class="toctree-l2"><a class="reference internal" href="../IP/W4_S2_Tutorial.html">1.15. Statistical Graphics with Seaborn</a></li>
<li class="toctree-l2"><a class="reference internal" href="../IP/W4_S2.html">1.16. (Exercise) Marathon Data Analysis</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">(Part II) Basics of Machine Learning for Earth and Environmental Sciences</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../ML/Week_1_Linear%26Logistic_Regression.html">2. Linear Regression for Regression, Logistic Regression for Classification and Statistical Forecasting</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Saranya/W1_2.html">2.1. Classification and Regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ML/S1_1_Classification.html">2.2. (Exercises) Classification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ML/S1_2_Training_Models.html">2.3. (Exercises) Training Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Saranya/W1_2_Stat.html">2.4. Statistical Forecasting in Environmental Sciences</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ML/S1_3_Statistical_Forecasting.html">2.5. (Exercises) Statistical Forecasting</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ML/Week_2_Decision_Trees_Random_Forests_SVMs.html">3. Decision Trees, Random Forests, Support Vector Machines and Environmental Risk Analysis</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Frederick/Simple_Machine_Learning_Algorithms_for_Classification_Tasks.html">3.1. Simple Machine Learning Algorithms for Classification Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Frederick/%28Exercises%29_Support_Vector_Machines.html">3.2. (Exercises) Support Vector Machines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Frederick/%28Exercises%29_Decision_Trees_and_Random_Forest.html">3.3. (Exercises) Decision Trees and Random Forest</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Frederick/%28Exercises%29_Ensemble_Modeling_and_Stacking.html">3.4. (Exercises) Ensemble Modeling and Stacking</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Frederick/%28Exercises%29_Wildfire_Susceptibility_Mapping.html">3.5. (Exercises) Wildfire Susceptibility Mapping</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ML/Week_3_Dimensionality_Reduction_Clustering.html">4. Unsupervised Learning for Clustering/Dimensionality Reduction and Environmental Complexity</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Jingyan/Chapter4-UnsupervisedLearning.html">4.1. Unsupervised Learning for Clustering and Dimensionality Reduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ML/S3_1_Dimensionality.html">4.2. (Exercise) Dimensionality Reduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ML/S3_2_Clustering.html">4.3. (Exercise) Clustering</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ML/S3_3_THOR.html">4.4. (Exercise) Ocean Regimes Identification</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">(Part III) Deep Learning for the Geosciences</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="Week_4_Artificial_Neural_Networks.html">5. Artificial Neural Networks and Surrogate Modeling</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="S4_1_NNs_with_Keras.html">5.1. (Exercise) Artificial Neural Networks with Keras</a></li>
<li class="toctree-l2"><a class="reference internal" href="S4_2_Physically_informed_parameterization.html">5.2. (Exercise) Physically-Informed Climate Modeling</a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="Week_5_Convolutional_NN.html">6. Convolutional Neural Networks and Remote Sensing</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../Jingyan/Ch5%20Convolutional%20Neural%20Networks%20%26%20Remote%20Sensing.html">6.1. Convolutional Neural Networks and Remote Sensing</a></li>
<li class="toctree-l2"><a class="reference internal" href="S5_1_CNNs.html">6.2. (Exercise) Deep Computer Vision</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">6.3. (Exercise) Land Cover Classification</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="Week_6_Recurrent_NN.html">7. Recurrent Neural Networks and Hydrological Modeling</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../Frederick/Neural_Networks_for_Time_Series_Predictions.html">7.1. Neural Networks for Time Series Predictions</a></li>
<li class="toctree-l2"><a class="reference internal" href="S6_1_Composing_Music_With_RNNs_CNNs.html">7.2. (Exercise) Composing Music</a></li>
<li class="toctree-l2"><a class="reference internal" href="S6_2_LSTM.html">7.3. <strong>Q6) Convert the prepared datasets into PyTorch Datasets</strong></a></li>






</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2FDL/S5_2_CNN_and_EuroSAT.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/DL/S5_2_CNN_and_EuroSAT.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Land Use and Land Cover Classification using CNN</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-instruction">6.3.1. Exercise Instruction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-setup">6.3.2. Data Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#q3-train-and-evaluate-the-model">6.3.3. Q3 Train and evaluate the model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#q7-explore-to-improve-the-model-performance-by-changing-the-model-structure">6.3.4. Q7 Explore to improve the model performance by changing the model structure</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#q8-explore-to-improve-the-model-performance-using-transfer-learning-from-pretrained-model">6.3.5. Q8 Explore to improve the model performance using transfer learning from pretrained model</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <p><a href="https://colab.research.google.com/github/tbeucler/2023_MLEES_JB/blob/main/ML_EES/DL/S5_2_CNN_and_EuroSAT.ipynb" target="_parent"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/></a></p>
<div class="tex2jax_ignore mathjax_ignore section" id="land-use-and-land-cover-classification-using-cnn">
<h1><span class="section-number">6.3. </span>Land Use and Land Cover Classification using CNN<a class="headerlink" href="#land-use-and-land-cover-classification-using-cnn" title="Permalink to this headline">#</a></h1>
<p><img alt="EuroSAT overview image" src="https://raw.githubusercontent.com/phelber/EuroSAT/master/eurosat_overview_small.jpg" /></p>
<p>This notebook is converted from the source, which is a MOOC on TensorFlow: <a class="reference external" href="https://www.coursera.org/learn/getting-started-with-tensor-flow2">https://www.coursera.org/learn/getting-started-with-tensor-flow2</a></p>
<div class="section" id="exercise-instruction">
<h2><span class="section-number">6.3.1. </span>Exercise Instruction<a class="headerlink" href="#exercise-instruction" title="Permalink to this headline">#</a></h2>
<p>Land Use and Land Cover Classification aims to automatically provide labels describing the represented physical land type or how a land area is used (e.g., residential, industrial).</p>
<p>Convolutional Neural Networks (CNNs),  the state of-the-art image classification method in computer vision and machine learning, have been reported to be suitable for the classification of remotely sensed
images.</p>
<p>However, the classification of remotely sensed images is a challenging task, particularly due to the lack of reliably labeled ground truth datasets.</p>
<p>The <a class="reference external" href="https://github.com/phelber/EuroSAT">EuroSAT dataset</a> provides large quantity of training data for this purpose. It consists of 27000 labelled Sentinel-2 satellite images of different land uses: residential, industrial, highway, river, forest, pasture, herbaceous vegetation, annual crop, permanent crop and sea/lake.</p>
<p>For a reference, see the following papers:</p>
<ul class="simple">
<li><p>Eurosat: A novel dataset and deep learning benchmark for land use and land cover classification. Patrick Helber, Benjamin Bischke, Andreas Dengel, Damian Borth. IEEE Journal of Selected Topics in Applied Earth Observations and Remote Sensing, 2019.</p></li>
<li><p>Introducing EuroSAT: A Novel Dataset and Deep Learning Benchmark for Land Use and Land Cover Classification. Patrick Helber, Benjamin Bischke, Andreas Dengel. 2018 IEEE International Geoscience and Remote Sensing Symposium, 2018.</p></li>
</ul>
<p><strong>In this exercise,  we</strong></p>
<ol class="arabic simple">
<li><p>Construct CNNs that classifies EuroSAT images into one of its 10 classes;</p></li>
<li><p>Saving and loading trained models;</p></li>
<li><p>Explore ways to improve the model performance.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run this cell first to import all required packages.</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.preprocessing.image</span> <span class="kn">import</span> <span class="n">load_img</span><span class="p">,</span> <span class="n">img_to_array</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span><span class="p">,</span> <span class="n">load_model</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Flatten</span><span class="p">,</span> <span class="n">Conv2D</span><span class="p">,</span> <span class="n">MaxPooling2D</span><span class="p">,</span> <span class="n">Dropout</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.callbacks</span> <span class="kn">import</span> <span class="n">ModelCheckpoint</span><span class="p">,</span> <span class="n">EarlyStopping</span>

<span class="kn">from</span> <span class="nn">keras.utils</span> <span class="kn">import</span> <span class="n">plot_model</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="c1"># If you would like to make further imports from tensorflow, add them here</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># Run this cell first to import all required packages.</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="kn">from</span> <span class="nn">tensorflow.keras.preprocessing.image</span> <span class="kn">import</span> <span class="n">load_img</span><span class="p">,</span> <span class="n">img_to_array</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span><span class="p">,</span> <span class="n">load_model</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;tensorflow&#39;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="data-setup">
<h2><span class="section-number">6.3.2. </span>Data Setup<a class="headerlink" href="#data-setup" title="Permalink to this headline">#</a></h2>
<p>Using the EuroSAT dataset which consists of 27000 images and labels might crash colab due to limited RAM, thus we use a smaller subset of the original dataset - 4000 training images and 1000 testing images with roughly equal numbers of each class.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#DOWNLOAD DATA</span>
<span class="o">!</span>gdown<span class="w"> </span>1qojXiBPdOOkH-kUGxe4vhx20-z7yyq2M
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading...
From: https://drive.google.com/uc?id=1qojXiBPdOOkH-kUGxe4vhx20-z7yyq2M
To: /content/data_cnn.zip
100% 55.2M/55.2M [00:01&lt;00:00, 39.8MB/s]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>unzip<span class="w"> </span><span class="s1">&#39;/content/data_cnn.zip&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Archive:  /content/data_cnn.zip
   creating: data_cnn/
  inflating: data_cnn/eurosat_overview.jpg  
  inflating: data_cnn/x_test.npy     
  inflating: data_cnn/x_train.npy    
  inflating: data_cnn/y_test.npy     
  inflating: data_cnn/y_train.npy    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import the Eurosat data</span>

<span class="k">def</span> <span class="nf">load_eurosat_data</span><span class="p">():</span>
    <span class="n">data_dir</span> <span class="o">=</span> <span class="s1">&#39;/content/data_cnn&#39;</span>
    <span class="n">x_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;x_train.npy&#39;</span><span class="p">))</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;y_train.npy&#39;</span><span class="p">))</span>
    <span class="n">x_test</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;x_test.npy&#39;</span><span class="p">))</span>
    <span class="n">y_test</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;y_test.npy&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

<span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">load_eurosat_data</span><span class="p">()</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train</span> <span class="o">/</span> <span class="mf">255.0</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span> <span class="o">/</span> <span class="mf">255.0</span>
</pre></div>
</div>
</div>
</div>
<p>##Q1 Build a CNN</p>
<p>You can now construct a model to fit to the data. Using the Sequential API, build your model according to the following specifications:</p>
<ul class="simple">
<li><p>The model should use the input_shape in the function argument to set the input size in the first layer.</p></li>
<li><p>The first layer should be a Conv2D layer with 16 filters, a 3x3 kernel size, a ReLU activation function and ‘SAME’ padding. Name this layer ‘conv_1’.</p></li>
<li><p>The second layer should also be a Conv2D layer with 8 filters, a 3x3 kernel size, a ReLU activation function and ‘SAME’ padding. Name this layer ‘conv_2’.</p></li>
<li><p>The third layer should be a MaxPooling2D layer with a pooling window size of 8x8. Name this layer ‘pool_1’.</p></li>
<li><p>The fourth layer should be a Flatten layer, named ‘flatten’.</p></li>
<li><p>The fifth layer should be a Dense layer with 32 units, a ReLU activation. Name this layer ‘dense_1’.</p></li>
<li><p>The sixth and final layer should be a Dense layer with 10 units and softmax activation. Name this layer ‘dense_2’.</p></li>
</ul>
<p>In total, the network should have 6 layers.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build a Sequential model according to the above specification.</span>
<span class="c1"># Ensure the weights are initialised by providing the input_shape argument in the first layer.</span>
<span class="n">input_shape</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>

<span class="n">model1</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">([</span>
        <span class="n">Conv2D</span><span class="p">(</span><span class="mi">16</span><span class="p">,(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">padding</span><span class="o">=</span><span class="s1">&#39;SAME&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span><span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;conv_1&#39;</span><span class="p">),</span>
        <span class="n">Conv2D</span><span class="p">(</span><span class="mi">8</span><span class="p">,(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">padding</span><span class="o">=</span><span class="s1">&#39;SAME&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span><span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;conv_2&#39;</span><span class="p">),</span>
        <span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;pool_1&#39;</span><span class="p">),</span>
        <span class="n">Flatten</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;flatten&#39;</span><span class="p">),</span>
        <span class="n">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;dense_1&#39;</span><span class="p">),</span>
        <span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;dense_2&#39;</span><span class="p">)</span>
    <span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>##Q2 Compile and evaluate the initial model</p>
<ul class="simple">
<li><p>Compile the model with the Adam optimiser, sparse categorical cross entropy loss function, and a single accuracy metric.</p></li>
<li><p>Print the model summary and calculate its initialised test accuracy</p>
<ul>
<li><p>What’s the initial accuracy &amp; why?</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compile the model with the Adam optimiser, sparse categorical cross entropy loss function, and a single accuracy metric.</span>
<span class="n">model1</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span>
                  <span class="n">loss</span> <span class="o">=</span> <span class="s1">&#39;sparse_categorical_crossentropy&#39;</span><span class="p">,</span>
                  <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print the model summary</span>
<span class="n">model1</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate its initialised test accuracy</span>
<span class="n">test_loss</span><span class="p">,</span> <span class="n">test_acc</span> <span class="o">=</span> <span class="n">model1</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;accuracy: </span><span class="si">{acc:0.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acc</span><span class="o">=</span><span class="n">test_acc</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="q3-train-and-evaluate-the-model">
<h2><span class="section-number">6.3.3. </span>Q3 Train and evaluate the model<a class="headerlink" href="#q3-train-and-evaluate-the-model" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Fit the model with 15 epochs;</p></li>
<li><p>Store the fitting result in a variable history;</p></li>
<li><p>Evaluate the fitted model</p>
<ul>
<li><p>What’s the test accuracy after training the model? Does it improve from the initialization?</p></li>
</ul>
</li>
<li><p>Plot the model using <a class="reference external" href="https://keras.io/api/utils/model_plotting_utils/">Keras model plotting utilities</a></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit the model with 15 epochs and store the fitting result in a variable history.</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">15</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
                    <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/15
63/63 [==============================] - 20s 320ms/step - loss: 0.7620 - accuracy: 0.7287 - val_loss: 0.9518 - val_accuracy: 0.6470
Epoch 2/15
63/63 [==============================] - 18s 282ms/step - loss: 0.7649 - accuracy: 0.7315 - val_loss: 0.8979 - val_accuracy: 0.6760
Epoch 3/15
63/63 [==============================] - 17s 271ms/step - loss: 0.7369 - accuracy: 0.7310 - val_loss: 0.8620 - val_accuracy: 0.6920
Epoch 4/15
63/63 [==============================] - 18s 286ms/step - loss: 0.7313 - accuracy: 0.7372 - val_loss: 0.8910 - val_accuracy: 0.6900
Epoch 5/15
63/63 [==============================] - 19s 304ms/step - loss: 0.7202 - accuracy: 0.7412 - val_loss: 0.8735 - val_accuracy: 0.6670
Epoch 6/15
63/63 [==============================] - 17s 266ms/step - loss: 0.7051 - accuracy: 0.7515 - val_loss: 0.8257 - val_accuracy: 0.7050
Epoch 7/15
63/63 [==============================] - 17s 269ms/step - loss: 0.7164 - accuracy: 0.7380 - val_loss: 0.8243 - val_accuracy: 0.7160
Epoch 8/15
63/63 [==============================] - 19s 296ms/step - loss: 0.6822 - accuracy: 0.7498 - val_loss: 0.8420 - val_accuracy: 0.6930
Epoch 9/15
63/63 [==============================] - 17s 270ms/step - loss: 0.6618 - accuracy: 0.7692 - val_loss: 0.8474 - val_accuracy: 0.7000
Epoch 10/15
63/63 [==============================] - 17s 268ms/step - loss: 0.6379 - accuracy: 0.7722 - val_loss: 0.8805 - val_accuracy: 0.6900
Epoch 11/15
63/63 [==============================] - 18s 287ms/step - loss: 0.6561 - accuracy: 0.7605 - val_loss: 0.8198 - val_accuracy: 0.7040
Epoch 12/15
63/63 [==============================] - 18s 291ms/step - loss: 0.6298 - accuracy: 0.7720 - val_loss: 0.7993 - val_accuracy: 0.7190
Epoch 13/15
63/63 [==============================] - 17s 271ms/step - loss: 0.6151 - accuracy: 0.7793 - val_loss: 0.7904 - val_accuracy: 0.7250
Epoch 14/15
63/63 [==============================] - 17s 266ms/step - loss: 0.6341 - accuracy: 0.7732 - val_loss: 0.7901 - val_accuracy: 0.7240
Epoch 15/15
63/63 [==============================] - 18s 288ms/step - loss: 0.5966 - accuracy: 0.7860 - val_loss: 0.8128 - val_accuracy: 0.7010
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_history</span><span class="p">(</span><span class="n">history</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;model accuracy&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;accuracy&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;model loss&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plot_history</span><span class="p">(</span><span class="n">history</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/34ed87ca1d7bc4d15f236335566d6660327f12c522c69cef1795674e36a654e9.png" src="../_images/34ed87ca1d7bc4d15f236335566d6660327f12c522c69cef1795674e36a654e9.png" />
<img alt="../_images/bd05b2f196df97bc6ebb5800f393b046eee0016cc10bec2508162c4b5960c9a1.png" src="../_images/bd05b2f196df97bc6ebb5800f393b046eee0016cc10bec2508162c4b5960c9a1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate the test accuracy</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test accuracy: </span><span class="si">{acc:0.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acc</span><span class="o">=</span><span class="n">score</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Test accuracy: 0.701
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the model using Keras model plotting utilities</span>
<span class="n">plot_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">show_shapes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_layer_names</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;sequential&quot;
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 conv_1 (Conv2D)             (None, 64, 64, 16)        448       
                                                                 
 conv_2 (Conv2D)             (None, 64, 64, 8)         1160      
                                                                 
 pool_1 (MaxPooling2D)       (None, 8, 8, 8)           0         
                                                                 
 flatten (Flatten)           (None, 512)               0         
                                                                 
 dense_1 (Dense)             (None, 32)                16416     
                                                                 
 dense_2 (Dense)             (None, 10)                330       
                                                                 
=================================================================
Total params: 18354 (71.70 KB)
Trainable params: 18354 (71.70 KB)
Non-trainable params: 0 (0.00 Byte)
_________________________________________________________________
</pre></div>
</div>
<img alt="../_images/645d88f1e0f9830f148fb2b25730c6bdc245ab49d871a28552310369014cf483.png" src="../_images/645d88f1e0f9830f148fb2b25730c6bdc245ab49d871a28552310369014cf483.png" />
</div>
</div>
<p>##Q4 Create checkpoints to save model during training, with a criterion</p>
<p>You will now create three callbacks:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">checkpoint_every_epoch</span></code>: checkpoint that saves the model weights every epoch during training</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">checkpoint_best_only</span></code>: checkpoint that saves only the weights with the highest validation accuracy. Use the testing data as the validation data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">early_stopping</span></code>: early stopping object that ends training if the validation accuracy has not improved in 3 epochs.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a ModelCheckpoint object that:</span>
<span class="c1">#     - saves the weights only at the end of every epoch</span>
<span class="c1">#     - saves into a directory called &#39;checkpoints_every_epoch&#39; inside the current working directory</span>
<span class="c1">#     - generates filenames in that directory like &#39;checkpoint_XXX&#39; where</span>
<span class="c1">#       XXX is the epoch number formatted to have three digits, e.g. 001, 002, 003, etc.</span>

<span class="n">path_every</span> <span class="o">=</span> <span class="s1">&#39;checkpoints_every_epoch/checkpoint_</span><span class="si">{epoch:03d}</span><span class="s1">&#39;</span>
<span class="n">checkpoint_every_epoch</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
                           <span class="n">frequency</span><span class="o">=</span><span class="s1">&#39;epoch&#39;</span><span class="p">,</span>
                           <span class="n">save_weights_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>



<span class="c1"># Create a ModelCheckpoint object that:</span>
<span class="c1">#     - saves only the weights that generate the highest validation (testing) accuracy</span>
<span class="c1">#     - saves into a directory called &#39;checkpoints_best_only&#39; inside the current working directory</span>
<span class="c1">#     - generates a file called &#39;checkpoints_best_only/checkpoint&#39;</span>


<span class="n">path_best</span> <span class="o">=</span> <span class="s1">&#39;checkpoints_best_only/checkpoint&#39;</span>
<span class="n">checkpoint_best_only</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
                           <span class="n">frequency</span><span class="o">=</span><span class="s1">&#39;epoch&#39;</span><span class="p">,</span>
                           <span class="n">save_weights_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">save_best_only</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                           <span class="n">monitor</span> <span class="o">=</span> <span class="s1">&#39;val_accuracy&#39;</span><span class="p">,</span>
                           <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create an EarlyStopping callback that stops training when</span>
<span class="c1">#     the validation (testing) accuracy has not improved in the last 3 epochs.</span>
<span class="c1">#     HINT: use the EarlyStopping callback with the correct &#39;monitor&#39; and &#39;patience&#39;</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="n">early_stopping</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_accuracy&#39;</span><span class="p">,</span><span class="n">patience</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>##Q5 Train model using the callbacks</p>
<p>Now, you will train the model using the three callbacks you created. If you created the callbacks correctly, three things should happen:</p>
<ul class="simple">
<li><p>At the end of every epoch, the model weights are saved into a directory called <code class="docutils literal notranslate"><span class="pre">checkpoints_every_epoch</span></code></p></li>
<li><p>At the end of every epoch, the model weights are saved into a directory called <code class="docutils literal notranslate"><span class="pre">checkpoints_best_only</span></code> <strong>only</strong> if those weights lead to the highest test accuracy</p></li>
<li><p>Training stops when the testing accuracy has not improved in three epochs.</p></li>
</ul>
<p>You should then have two directories:</p>
<ul class="simple">
<li><p>A directory called <code class="docutils literal notranslate"><span class="pre">checkpoints_every_epoch</span></code> containing filenames that include <code class="docutils literal notranslate"><span class="pre">checkpoint_001</span></code>, <code class="docutils literal notranslate"><span class="pre">checkpoint_002</span></code>, etc with the <code class="docutils literal notranslate"><span class="pre">001</span></code>, <code class="docutils literal notranslate"><span class="pre">002</span></code> corresponding to the epoch</p></li>
<li><p>A directory called <code class="docutils literal notranslate"><span class="pre">checkpoints_best_only</span></code> containing filenames that include <code class="docutils literal notranslate"><span class="pre">checkpoint</span></code>, which contain only the weights leading to the highest testing accuracy</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Train model using the callbacks you just created</span>

<span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">checkpoint_every_epoch</span><span class="p">,</span> <span class="n">checkpoint_best_only</span><span class="p">,</span> <span class="n">early_stopping</span><span class="p">]</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model1</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span> <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/50
125/125 [==============================] - ETA: 0s - loss: 0.6566 - accuracy: 0.7602
Epoch 1: val_accuracy improved from -inf to 0.69700, saving model to checkpoints_best_only/checkpoint
125/125 [==============================] - 17s 138ms/step - loss: 0.6566 - accuracy: 0.7602 - val_loss: 0.8400 - val_accuracy: 0.6970
Epoch 2/50
125/125 [==============================] - ETA: 0s - loss: 0.6156 - accuracy: 0.7800
Epoch 2: val_accuracy did not improve from 0.69700
125/125 [==============================] - 17s 137ms/step - loss: 0.6156 - accuracy: 0.7800 - val_loss: 0.8496 - val_accuracy: 0.6950
Epoch 3/50
125/125 [==============================] - ETA: 0s - loss: 0.6078 - accuracy: 0.7797
Epoch 3: val_accuracy improved from 0.69700 to 0.71200, saving model to checkpoints_best_only/checkpoint
125/125 [==============================] - 19s 148ms/step - loss: 0.6078 - accuracy: 0.7797 - val_loss: 0.7982 - val_accuracy: 0.7120
Epoch 4/50
125/125 [==============================] - ETA: 0s - loss: 0.6112 - accuracy: 0.7828
Epoch 4: val_accuracy improved from 0.71200 to 0.71500, saving model to checkpoints_best_only/checkpoint
125/125 [==============================] - 17s 135ms/step - loss: 0.6112 - accuracy: 0.7828 - val_loss: 0.7974 - val_accuracy: 0.7150
Epoch 5/50
125/125 [==============================] - ETA: 0s - loss: 0.5815 - accuracy: 0.7918
Epoch 5: val_accuracy improved from 0.71500 to 0.71600, saving model to checkpoints_best_only/checkpoint
125/125 [==============================] - 17s 135ms/step - loss: 0.5815 - accuracy: 0.7918 - val_loss: 0.8375 - val_accuracy: 0.7160
Epoch 6/50
125/125 [==============================] - ETA: 0s - loss: 0.5642 - accuracy: 0.8002
Epoch 6: val_accuracy improved from 0.71600 to 0.73900, saving model to checkpoints_best_only/checkpoint
125/125 [==============================] - 20s 159ms/step - loss: 0.5642 - accuracy: 0.8002 - val_loss: 0.7757 - val_accuracy: 0.7390
Epoch 7/50
125/125 [==============================] - ETA: 0s - loss: 0.5549 - accuracy: 0.7990
Epoch 7: val_accuracy did not improve from 0.73900
125/125 [==============================] - 17s 135ms/step - loss: 0.5549 - accuracy: 0.7990 - val_loss: 0.7655 - val_accuracy: 0.7310
Epoch 8/50
125/125 [==============================] - ETA: 0s - loss: 0.5542 - accuracy: 0.8048
Epoch 8: val_accuracy did not improve from 0.73900
125/125 [==============================] - 17s 136ms/step - loss: 0.5542 - accuracy: 0.8048 - val_loss: 0.7839 - val_accuracy: 0.7280
Epoch 9/50
125/125 [==============================] - ETA: 0s - loss: 0.5381 - accuracy: 0.8037
Epoch 9: val_accuracy did not improve from 0.73900
125/125 [==============================] - 18s 146ms/step - loss: 0.5381 - accuracy: 0.8037 - val_loss: 0.7953 - val_accuracy: 0.7230
</pre></div>
</div>
</div>
</div>
<p>##Q6 Create new instance of model and load on both sets of weights</p>
<p>Now you will use the weights you just saved in a fresh model. You should create two functions, both of which take a freshly instantiated model instance:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">model_last_epoch</span></code> should contain the weights from the latest saved epoch</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">model_best_epoch</span></code> should contain the weights from the saved epoch with the highest testing accuracy</p></li>
</ul>
<p><em>Hint: use the</em> <code class="docutils literal notranslate"><span class="pre">tf.train.latest_checkpoint</span></code> <em>function to get the filename of the latest saved checkpoint file. Check the docs</em> <a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/train/latest_checkpoint"><em>here</em></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a new instance of the CNN you created earlier,</span>
<span class="n">input_shape</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">([</span>
        <span class="n">Conv2D</span><span class="p">(</span><span class="mi">16</span><span class="p">,(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">padding</span><span class="o">=</span><span class="s1">&#39;SAME&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span><span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;conv_1&#39;</span><span class="p">),</span>
        <span class="n">Conv2D</span><span class="p">(</span><span class="mi">8</span><span class="p">,(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">padding</span><span class="o">=</span><span class="s1">&#39;SAME&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span><span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;conv_2&#39;</span><span class="p">),</span>
        <span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;pool_1&#39;</span><span class="p">),</span>
        <span class="n">Flatten</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;flatten&#39;</span><span class="p">),</span>
        <span class="n">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;dense_1&#39;</span><span class="p">),</span>
        <span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;dense_2&#39;</span><span class="p">)</span>
    <span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span>
                  <span class="n">loss</span> <span class="o">=</span> <span class="s1">&#39;sparse_categorical_crossentropy&#39;</span><span class="p">,</span>
                  <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

<span class="c1"># Load on the weights from the last training epoch.</span>
<span class="n">model_last_epoch</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">latest_checkpoint</span><span class="p">(</span><span class="s1">&#39;checkpoints_every_epoch&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a new instance of the CNN you created earlier,</span>
<span class="n">input_shape</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">([</span>
        <span class="n">Conv2D</span><span class="p">(</span><span class="mi">16</span><span class="p">,(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">padding</span><span class="o">=</span><span class="s1">&#39;SAME&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span><span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;conv_1&#39;</span><span class="p">),</span>
        <span class="n">Conv2D</span><span class="p">(</span><span class="mi">8</span><span class="p">,(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">padding</span><span class="o">=</span><span class="s1">&#39;SAME&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span><span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;conv_2&#39;</span><span class="p">),</span>
        <span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;pool_1&#39;</span><span class="p">),</span>
        <span class="n">Flatten</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;flatten&#39;</span><span class="p">),</span>
        <span class="n">Dense</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;dense_1&#39;</span><span class="p">),</span>
        <span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;dense_2&#39;</span><span class="p">)</span>
    <span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span>
                  <span class="n">loss</span> <span class="o">=</span> <span class="s1">&#39;sparse_categorical_crossentropy&#39;</span><span class="p">,</span>
                  <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

<span class="c1"># Load the weights leading to the highest validation accuracy.</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="n">model_best_epoch</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="s1">&#39;checkpoints_best_only/checkpoint&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Verify that the accuarcy of the last and model model.</span>

<span class="n">score</span> <span class="o">=</span> <span class="n">model_last_epoch</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model with last epoch weights: </span><span class="si">{acc:0.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acc</span><span class="o">=</span><span class="n">score</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="n">score</span> <span class="o">=</span> <span class="n">model_best_epoch</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model with best epoch weights: </span><span class="si">{acc:0.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acc</span><span class="o">=</span><span class="n">score</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Test accuracy: 0.739
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="q7-explore-to-improve-the-model-performance-by-changing-the-model-structure">
<h2><span class="section-number">6.3.4. </span>Q7 Explore to improve the model performance by changing the model structure<a class="headerlink" href="#q7-explore-to-improve-the-model-performance-by-changing-the-model-structure" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Change the convolution layer parameters</p></li>
<li><p>Add Dropout layers</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build a Sequential model model2 with same specification as the previous model1,</span>
<span class="c1"># but change the number of filters in the first convolution layer to 32 and second convolution layer to 64.</span>
<span class="c1"># Also add two dropout layers - one after the max pooling layer, one before the final dense layer.</span>
<span class="c1"># Ensure the weights are initialised by providing the input_shape argument in the first layer.</span>
<span class="n">input_shape</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>

<span class="n">model2</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">([</span>
        <span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">padding</span><span class="o">=</span><span class="s1">&#39;SAME&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span><span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;conv_1&#39;</span><span class="p">),</span>
        <span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">padding</span><span class="o">=</span><span class="s1">&#39;SAME&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span><span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;conv_2&#39;</span><span class="p">),</span>
        <span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;pool_1&#39;</span><span class="p">),</span>
        <span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
        <span class="n">Flatten</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;flatten&#39;</span><span class="p">),</span>
        <span class="n">Dense</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;dense_1&#39;</span><span class="p">),</span>
        <span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
        <span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;dense_2&#39;</span><span class="p">)</span>
    <span class="p">])</span>
<span class="n">model2</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span>
                  <span class="n">loss</span> <span class="o">=</span> <span class="s1">&#39;sparse_categorical_crossentropy&#39;</span><span class="p">,</span>
                  <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the model</span>
<span class="n">plot_model</span><span class="p">(</span><span class="n">model2</span><span class="p">,</span> <span class="n">show_shapes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_layer_names</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/47825e1af28411a86817b42a49e8fcd4f2660abe284409e23d64de474919ed8d.png" src="../_images/47825e1af28411a86817b42a49e8fcd4f2660abe284409e23d64de474919ed8d.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Train the model and store the results in a variable called history</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">early_stopping</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/50
125/125 [==============================] - 64s 507ms/step - loss: 1.7593 - accuracy: 0.3142 - val_loss: 1.4106 - val_accuracy: 0.4480
Epoch 2/50
125/125 [==============================] - 65s 522ms/step - loss: 1.3109 - accuracy: 0.4960 - val_loss: 1.2002 - val_accuracy: 0.5280
Epoch 3/50
125/125 [==============================] - 64s 509ms/step - loss: 1.0940 - accuracy: 0.5987 - val_loss: 1.0006 - val_accuracy: 0.6500
Epoch 4/50
125/125 [==============================] - 64s 512ms/step - loss: 0.9107 - accuracy: 0.6697 - val_loss: 0.9739 - val_accuracy: 0.6590
Epoch 5/50
125/125 [==============================] - 65s 523ms/step - loss: 0.8024 - accuracy: 0.7180 - val_loss: 0.7905 - val_accuracy: 0.7020
Epoch 6/50
125/125 [==============================] - 67s 539ms/step - loss: 0.7405 - accuracy: 0.7350 - val_loss: 0.7419 - val_accuracy: 0.7150
Epoch 7/50
125/125 [==============================] - 62s 497ms/step - loss: 0.7036 - accuracy: 0.7485 - val_loss: 0.6585 - val_accuracy: 0.7620
Epoch 8/50
125/125 [==============================] - 64s 515ms/step - loss: 0.6202 - accuracy: 0.7810 - val_loss: 0.7323 - val_accuracy: 0.7280
Epoch 9/50
125/125 [==============================] - 65s 524ms/step - loss: 0.5999 - accuracy: 0.7903 - val_loss: 0.6456 - val_accuracy: 0.7680
Epoch 10/50
125/125 [==============================] - 69s 553ms/step - loss: 0.5392 - accuracy: 0.8077 - val_loss: 0.6250 - val_accuracy: 0.7730
Epoch 11/50
125/125 [==============================] - 65s 520ms/step - loss: 0.4924 - accuracy: 0.8288 - val_loss: 0.6151 - val_accuracy: 0.7740
Epoch 12/50
125/125 [==============================] - 67s 536ms/step - loss: 0.4553 - accuracy: 0.8438 - val_loss: 0.5732 - val_accuracy: 0.7920
Epoch 13/50
125/125 [==============================] - 67s 539ms/step - loss: 0.4431 - accuracy: 0.8420 - val_loss: 0.5783 - val_accuracy: 0.7910
Epoch 14/50
125/125 [==============================] - 64s 509ms/step - loss: 0.3915 - accuracy: 0.8595 - val_loss: 0.5442 - val_accuracy: 0.8090
Epoch 15/50
125/125 [==============================] - 66s 524ms/step - loss: 0.3630 - accuracy: 0.8702 - val_loss: 0.5060 - val_accuracy: 0.8240
Epoch 16/50
125/125 [==============================] - 71s 567ms/step - loss: 0.3490 - accuracy: 0.8830 - val_loss: 0.5336 - val_accuracy: 0.8180
Epoch 17/50
125/125 [==============================] - 66s 530ms/step - loss: 0.3127 - accuracy: 0.8920 - val_loss: 0.5383 - val_accuracy: 0.8200
Epoch 18/50
125/125 [==============================] - 74s 591ms/step - loss: 0.2942 - accuracy: 0.8992 - val_loss: 0.5750 - val_accuracy: 0.8090
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate the test accuracy</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">model2</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test accuracy: </span><span class="si">{acc:0.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acc</span><span class="o">=</span><span class="n">score</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Test accuracy: 0.809
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="q8-explore-to-improve-the-model-performance-using-transfer-learning-from-pretrained-model">
<h2><span class="section-number">6.3.5. </span>Q8 Explore to improve the model performance using transfer learning from pretrained model<a class="headerlink" href="#q8-explore-to-improve-the-model-performance-using-transfer-learning-from-pretrained-model" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Use pretrained models from Keras Applications <a class="reference external" href="https://keras.io/api/applications/vgg/#vgg16-function">vgg16 </a></p>
<ul>
<li><p>Does the model performance improve after the above explorations?</p></li>
<li><p>How would you further improve the model performance?</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">keras.applications</span> <span class="kn">import</span> <span class="n">vgg16</span>

<span class="n">conv_base</span> <span class="o">=</span> <span class="n">vgg16</span><span class="o">.</span><span class="n">VGG16</span><span class="p">(</span><span class="n">include_top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">input_shape</span> <span class="o">=</span> <span class="n">input_shape</span><span class="p">)</span>
<span class="c1"># freeze the weights</span>
<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">conv_base</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">model3</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">([</span>
        <span class="n">conv_base</span><span class="p">,</span>
        <span class="n">Flatten</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;flatten&#39;</span><span class="p">),</span>
        <span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
        <span class="n">Dense</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;dense_1&#39;</span><span class="p">),</span>
        <span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
        <span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;dense_2&#39;</span><span class="p">)</span>
    <span class="p">])</span>
<span class="n">model3</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span>
                  <span class="n">loss</span> <span class="o">=</span> <span class="s1">&#39;sparse_categorical_crossentropy&#39;</span><span class="p">,</span>
                  <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading data from https://storage.googleapis.com/tensorflow/keras-applications/vgg16/vgg16_weights_tf_dim_ordering_tf_kernels_notop.h5
58889256/58889256 [==============================] - 0s 0us/step
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">history</span> <span class="o">=</span> <span class="n">model3</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">early_stopping</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/50
125/125 [==============================] - 275s 2s/step - loss: 1.1468 - accuracy: 0.5920 - val_loss: 0.7427 - val_accuracy: 0.7280
Epoch 2/50
125/125 [==============================] - 277s 2s/step - loss: 0.7360 - accuracy: 0.7368 - val_loss: 0.6047 - val_accuracy: 0.7800
Epoch 3/50
125/125 [==============================] - 272s 2s/step - loss: 0.6235 - accuracy: 0.7843 - val_loss: 0.6232 - val_accuracy: 0.7500
Epoch 4/50
125/125 [==============================] - 234s 2s/step - loss: 0.5708 - accuracy: 0.7997 - val_loss: 0.5486 - val_accuracy: 0.8040
Epoch 5/50
125/125 [==============================] - 269s 2s/step - loss: 0.5180 - accuracy: 0.8167 - val_loss: 0.5108 - val_accuracy: 0.8090
Epoch 6/50
125/125 [==============================] - 282s 2s/step - loss: 0.4662 - accuracy: 0.8313 - val_loss: 0.5192 - val_accuracy: 0.8120
Epoch 7/50
125/125 [==============================] - 278s 2s/step - loss: 0.4459 - accuracy: 0.8457 - val_loss: 0.5740 - val_accuracy: 0.8050
Epoch 8/50
125/125 [==============================] - 286s 2s/step - loss: 0.4431 - accuracy: 0.8480 - val_loss: 0.5119 - val_accuracy: 0.8100
Epoch 9/50
125/125 [==============================] - 284s 2s/step - loss: 0.4140 - accuracy: 0.8533 - val_loss: 0.4756 - val_accuracy: 0.8310
Epoch 10/50
125/125 [==============================] - 296s 2s/step - loss: 0.3877 - accuracy: 0.8587 - val_loss: 0.4544 - val_accuracy: 0.8480
Epoch 11/50
125/125 [==============================] - 284s 2s/step - loss: 0.3665 - accuracy: 0.8665 - val_loss: 0.4652 - val_accuracy: 0.8320
Epoch 12/50
125/125 [==============================] - 279s 2s/step - loss: 0.3449 - accuracy: 0.8810 - val_loss: 0.4873 - val_accuracy: 0.8440
Epoch 13/50
125/125 [==============================] - 286s 2s/step - loss: 0.3456 - accuracy: 0.8730 - val_loss: 0.4379 - val_accuracy: 0.8440
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate the test accuracy</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">model3</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test accuracy: </span><span class="si">{acc:0.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acc</span><span class="o">=</span><span class="n">score</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Test accuracy: 0.844
</pre></div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./DL"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="S5_1_CNNs.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">6.2. </span>Deep Computer Vision</p>
      </div>
    </a>
    <a class="right-next"
       href="Week_6_Recurrent_NN.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">7. </span>Recurrent Neural Networks and Hydrological Modeling</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-instruction">6.3.1. Exercise Instruction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-setup">6.3.2. Data Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#q3-train-and-evaluate-the-model">6.3.3. Q3 Train and evaluate the model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#q7-explore-to-improve-the-model-performance-by-changing-the-model-structure">6.3.4. Q7 Explore to improve the model performance by changing the model structure</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#q8-explore-to-improve-the-model-performance-using-transfer-learning-from-pretrained-model">6.3.5. Q8 Explore to improve the model performance using transfer learning from pretrained model</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Tom Beucler, Milton Gomez, Frederick Iat-Hin Tam, Jingyan Yu, Saranya Ganesh S
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>